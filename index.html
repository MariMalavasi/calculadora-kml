<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de √Årea KML com Reproje√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Turf.js para c√°lculo de √°rea -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <!-- Proj4js para reproje√ß√£o de coordenadas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>

  <!-- reproject para reproje√ß√£o de GeoJSON -->
  <script src="https://unpkg.com/reproject@2.2.0/dist/reproject.min.js"></script>

  <!-- toGeoJSON para converter KML -->
  <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 80vh;
    }

    .controls {
      padding: 1em;
      background-color: #f8f8f8;
    }

    .output {
      margin-top: 1em;
      font-size: 1.1em;
      font-weight: bold;
    }

    input[type="file"] {
      font-size: 1em;
      padding: 0.5em;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="controls">
    <input type="file" id="fileInput" accept=".kml">
    <div class="output" id="output">Selecione um arquivo .kml para calcular a √°rea.</div>
  </div>

  <script>
    const map = L.map('map').setView([-14.2350, -51.9253], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const output = document.getElementById('output');

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      alert("üìÅ Arquivo KML carregado! Calculando a √°rea...");

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const parser = new DOMParser();
          const kmlDoc = parser.parseFromString(event.target.result, 'application/xml');
          const geojson = toGeoJSON.kml(kmlDoc);

          if (window.kmlLayer) {
            map.removeLayer(window.kmlLayer);
          }

          // Definir a proje√ß√£o de destino (por exemplo, UTM zona 23S para o Brasil)
          const proj4UTM = "+proj=utm +zone=23 +south +datum=WGS84 +units=m +no_defs";

          // Reprojetar o GeoJSON para a proje√ß√£o UTM
          const geojsonUTM = reproject.reproject(geojson, proj4.defs('EPSG:4326'), proj4UTM, proj4);

          let totalArea = 0;
          let validFeatures = 0;

          geojsonUTM.features.forEach(feature => {
            const geom = feature.geometry;
            if (geom && (geom.type === 'Polygon' || geom.type === 'MultiPolygon')) {
              try {
                const area = turf.area(feature);
                totalArea += area;
                validFeatures += 1;
              } catch (err) {
                console.warn('Erro ao calcular √°rea de uma feature:', err);
              }
            }
          });

          if (validFeatures === 0) {
            output.innerHTML = "‚ùå Nenhum pol√≠gono v√°lido encontrado no KML.";
            alert("‚ö†Ô∏è O arquivo foi carregado, mas n√£o cont√©m pol√≠gonos utiliz√°veis.");
            return;
          }

          const hectares = totalArea / 10000;

          output.innerHTML = `
            ‚úÖ <strong>√Årea total:</strong> ${totalArea.toFixed(2)} m¬≤<br>
            üåø <strong>Hectares:</strong> ${hectares.toFixed(4)} ha
          `;

          alert("‚úÖ C√°lculo finalizado! Confira o resultado abaixo.");

          window.kmlLayer = L.geoJSON(geojson, {
            style: { color: 'green', weight: 2 }
          }).addTo(map);

          map.fitBounds(window.kmlLayer.getBounds(), { padding: [20, 20] });

        } catch (err) {
          output.innerHTML = "‚ùå Erro ao processar o arquivo.";
          alert("‚ùå Ocorreu um erro ao processar o KML. Verifique o console.");
          console.error(err);
        }
      };

      reader.readAsText(file);
    });
  </script>

</body>
</html>
