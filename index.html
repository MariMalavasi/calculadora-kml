<script>
  const map = L.map("map").setView([0, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors",
  }).addTo(map);

  document.getElementById("upload").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function () {
      try {
        const parser = new DOMParser();
        const kml = parser.parseFromString(reader.result, "text/xml");
        const geojson = toGeoJSON.kml(kml);

        // Filtra apenas Polygon ou MultiPolygon
        const validPolygons = {
          type: "FeatureCollection",
          features: geojson.features.filter(f => {
            return f.geometry && ["Polygon", "MultiPolygon"].includes(f.geometry.type);
          }),
        };

        if (validPolygons.features.length === 0) {
          alert("⚠️ Nenhum polígono válido encontrado no arquivo KML.");
          return;
        }

        // Remove camada anterior
        if (window.layer) map.removeLayer(window.layer);

        // Adiciona nova camada ao mapa
        window.layer = L.geoJSON(validPolygons, {
          style: { color: "blue", weight: 2, fillOpacity: 0.4 },
        }).addTo(map);
        map.fitBounds(window.layer.getBounds());

        // Calcular área total
        let totalArea = 0;
        validPolygons.features.forEach(f => {
          try {
            totalArea += turf.area(f);  // metros quadrados
          } catch (err) {
            console.warn("Erro ao calcular área de um feature:", err);
          }
        });

        const areaHa = totalArea / 10000;
        document.getElementById("areaResult").textContent =
          `Área total: ${totalArea.toLocaleString(undefined, { maximumFractionDigits: 2 })} m² (${areaHa.toFixed(2)} ha)`;

      } catch (error) {
        console.error("Erro geral:", error);
        alert("❌ Ocorreu um erro ao processar o arquivo KML.");
      }
    };

    reader.readAsText(file);
  });
</script>
