<script>
  const map = L.map("map").setView([0, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors",
  }).addTo(map);

  document.getElementById("upload").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function () {
      try {
        const parser = new DOMParser();
        const kml = parser.parseFromString(reader.result, "text/xml");
        const geojson = toGeoJSON.kml(kml);

        // Filtra apenas polígonos válidos
        const validPolygons = {
          type: "FeatureCollection",
          features: geojson.features.filter(
            (f) => f.geometry && ["Polygon", "MultiPolygon"].includes(f.geometry.type)
          ),
        };

        if (validPolygons.features.length === 0) {
          alert("Nenhum polígono válido encontrado no arquivo.");
          return;
        }

        // Remove camadas anteriores
        if (window.layer) map.removeLayer(window.layer);

        // Adiciona ao mapa
        window.layer = L.geoJSON(validPolygons).addTo(map);
        map.fitBounds(window.layer.getBounds());

        // Calcular área
        const area_m2 = turf.area(validPolygons);
        const area_ha = area_m2 / 10000;

        document.getElementById("areaResult").textContent =
          `Área total: ${area_m2.toLocaleString(undefined, {maximumFractionDigits: 2})} m² (${area_ha.toFixed(2)} ha)`;

      } catch (error) {
        console.error("Erro ao processar o arquivo:", error);
        alert("Houve um erro ao processar o arquivo KML. Verifique se ele está válido.");
      }
    };

    reader.readAsText(file);
  });
</script>